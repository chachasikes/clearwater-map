<!DOCTYPE html>
<html>
<head>
  <meta charset='UTF-8'/>
  <meta name="viewport" content="width=device-width">
  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <script src='http://underscorejs.org/underscore-min.js'></script>
  <script src='http://api.tiles.mapbox.com/mapbox.js/v1.0.0/mapbox.js'></script>
  <script src='bing.js'></script>
  <script src='oms.min.js'></script>
  <script src='google-spreadsheet-importer.js'></script>
  <link href='http://api.tiles.mapbox.com/mapbox.js/v1.0.0/mapbox.css' rel='stylesheet' />
  <link href='map.css' rel='stylesheet' />
  <!--[if lte IE 8]>
  <link href='http://api.tiles.mapbox.com/mapbox.js/v1.0.0/mapbox.ie.css' rel='stylesheet' >
  <![endif]-->
</head>
<body class="overview-section-0">

<div id='pane'><div id='map'></div></div>

<article class='overview active'>
  <section class='cover active' id="ecuador">
    <h1>ClearWater in Ecuador</h1>
    <p>The Amazon rainforest produces 20% of our planet's freshwater. Yet, in the northeastern Ecuadorian Amazon, which is the ancestral home of five indigenous tribes, the rivers and streams have been contaminated by decades of reckless oil operations. More than 30,000 indigenous peoples and homesteading farmers in the northeastern Ecuadorian Amazon are suffering a massive public health crisis, including a wave of cancers, birth defects and spontaneous miscarriages, due principally to the persistence of oil-related heavy metals and toxins in the surface and groundwater. The absence of readily available clean water has also contributed to cultural loss, developmental disabilities, and economic impoverishment. While the local Amazonian communities fight a protracted and contentious lawsuit with the American oil giant Chevron, demanding the cleanup and restoration of their territory, ClearWater is partnering with five 
indigenous tribes--Cofan, Siona, Secoya, Quichua, and Huaorani--to address the immediate environmental and health crisis. </p>

<p>Through community-led construction of family-size rainwater harvesting systems, which have proven to be one of the most practical, effective, and culturally appropriate solutions to the water crisis gripping the region, ClearWater works with the tribes to meet the needs of the affected indigenous population of Sucumbios and Orellana provinces (the 
former Chevron oil concession area). Indeed, in the absence of a full-scale environmental remediation, rainwater harvesting might be the only viable and lasting solution.</p>

<p>ClearWater has installed over XX units in YY communities, but there are ZZ more affected communities living without adequate supplies of fresh water right now. Find out how you can help.</p>
    <small class='scroll'>Scroll ▼</small>
  </section>

  <section id="secoya">
    <h2>The Secoya</h2>
    <img src="images/secoya.jpg">
    <ul class="tribe-details">
      <li>Community:  San Pablo de Kantesiaya </li>
      <li>17 Rainwater Catchment Systems</li>
      <li>100 people benefitted</li>
      <li>4 community technicians trained</li>
    </ul>
    <p>Installation of rain catchment systems first began in the Secoya community of San Pablo de Kantesiaya in May 2012. The construction of 17 units has provided clean water to more than 100 Secoya community members. Similar to the other nationalities in the region, the Secoya and their way of life have been  impacted by upstream oil operations. Despite a significantly reduced population, the Secoya are highly organized and dedicated to building clean water solutions for their people. Plans are underway to continue installation of 96 systems in July, so that all Secoya families have access to clean water.</p>
    <h4>History</h4>
    <p>The Secoya, or Siekopai, people traditionally inhabited a very large territory between the Putumayo and Napo rivers in Ecuador, Colombia, and Peru. They are renowned for their shamanic acumen and knowledge of medicinal plants. Their language, Pai’koka, is part of the Western Tucanoan language group. Missionary activity, rubber extraction, colonization, African palm production, and oil activity have reduced Secoya territory to less than 30,000 hectares in Sucumbíos Province, Ecuador--a tiny fraction of their ancestral territory.</p>

<p>The Secoya now number around 600 people in Ecuador and around 900 in Peru. In Ecuador, the Secoya are concentrated in three communities along the Aguarico River: San Pablo de Katetsiaya, Siecoya Remolino Ñe'ñena and Eno. The Secoya suffer heavily from oil-related contamination. Rivers have been contaminated, making much of the water unsafe to drink or bathe in. The Secoya are no longer able to get by solely on traditional subsistence activities like hunting, fishing, and growing edible crops. As a result, African palm production and oil extraction have a strong influence in the communities, rapidly degrading the remaining bit of rainforest the Secoya call home.</p>
    <small class='scroll'><a href="#">Read all Secoya stories</a></small>
  </section>   

  <section id="secoya-id1" class="featured">
    <h2><a href="#">Featured Story 1</a></h2>
    <img src="images/secoya.jpg">
    <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
    <small class='scroll'><a href="#">Read more</a></small>
  </section>

  <section id="secoya-id2" class="featured">
    <h2><a href="#">Featured Story 2</a></h2>
    <img src="images/secoya.jpg">
    <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
    <small class='scroll'><a href="#">Read more</a></small>
  </section>

  <section id="secoya-id3" class="featured">
    <h2><a href="#">Featured Story 3</a></h2>
    <img src="images/secoya.jpg">
    <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
    <small class='scroll'><a href="#">Read more</a></small>
  </section>

  <section id="siona">
    <h2>The Siona</h2>
    <img src="images/siona.jpg">
    <ul>
      <li>Community Sotosiaya</li>
      <li>20 Rainwater Catchment Systems</li>
      <li>100 people benefitted</li>
      <li>4 community technicians trained</li>
    </ul>
    <p>ClearWater began installation in the Siona community of Sotosiaya in October of 2012. 20 rain catchment systems were built, benefitting over 100 people. The Siona have suffered greatly during and after oil operations by US oil companies Texaco and Occidental Petroleum, and by state oil company Petroecuador, resulting in territorial loss, environmental degradation, and serious health problems. Siona technicians working for ClearWater are dedicated to improving the living conditions for all Siona community members by providing them with clean drinking water. Installation will continue in the fall of 2013, bringing clean water to the remaining 7 Siona communities.</p>
    <h4>History</h4>
    <p>The Siona people have often been paired with their Secoya relatives, both members of the Western Tucanoan language family. Although formerly considered one ethnic group, the “Secoya-Siona”, these two are increasingly proving that they are quite independent of each other. The Siona live in the territories of modern Colombia and Ecuador. In 
Ecuador, they are settled in the province of Sucumbios, in the cantons of Putumayo, and Shushufindi. Their population is approximately 350 and 400 people sparsely settled in several communities, including Puerto Bolivar, Sottosiaya, Bi'aña and Orahuëaya, amongst others. Their territory borders that of the Secoya people, with whom they share a common language and ancestry. Like the Secoya, the Siona currently suffer from oil contamination, African palm production, deforestation, and expanding colonist settlement in their territory.</p>
    <small class='scroll'><a href="#">More about the Siona</a></small>
  </section>

  <section id="waorani">
    <h2>The Waorani</h2>
    <img src="images/waorani.jpg">
    <ul>
      <li>Community Yawepare and Nampo Eno</li>
      <li>13 Rainwater Catchment Systems</li>
      <li>75 people benefitted</li>
      <li>4 community technicians trained</li>
    </ul>
    <p>Due to their location downriver from oil operations, even Waorani 
communities within the protected Yasuní National Park have been 
affected. ClearWater began a pilot project in the communities of 
Yawepare and Nampo Eno on March 10, 2013 working with the Waorani and 
using a new design for metal catchment system frames that will last five
 times longer than wooden frames. 13 systems were built, benefitting 75 
people. ClearWater will be expanding its work with the Waorani in the 
near future, in collaboration with the Waorani Nationality Organization 
of Orellana, ONWO, to provide clean water for all Waorani communities in
 Orellana province.</p>
    <h4>History</h4>
    <p>The Waorani once maintained one of the largest territories of all indigenous Amazonians in Ecuador, within the modern provinces of Orellana, Napo, and Pastaza. They traditionally lived as nomadic hunter-gatherers in small clan settlements. Missionary groups relocated many Waorani families into large communities with the purpose of 
converting them to Christianity.</p>

<p>The Waorani were the most recently contacted of all Ecuadorian indigenous peoples, first reached by a missionary group in 1956. Since first contact, the Waorani have experienced a rapid and difficult insertion into mainstream Ecuadorian society. Their territories have been greatly reduced, and their remaining lands impacted by logging, oil extraction, 
and colonist settlement, among other issues. Several Waorani groups have rejected contact and move ever deeper into the forest. Oil activity and the construction of oil roads has been severely detrimental to Waorani lands. Despite the location of several Waorani communities within the supposed protection of Yasuní National Park, being downriver from oil operations has still drastically affected these communities and their water supply.</p>
    <small class='scroll'><a href="#">More about the Waorani</a></small>
  </section>


  <section id="kichwa">
    <h2>The Kichwa</h2>
    <img src="images/kichwa.jpg">
    <ul>
      <li>Community of Rumipamba</li>
      <li>53 Rainwater Catchment Systems</li>
      <li>350 people benefitted</li>
      <li>4 community technicians trained</li>
    </ul>
    <p>The Kichwa of Rumipamba have been at the center of devastating oil 
operations for decades, as well as the fight to bring multinational oil 
company Chevron to justice. They have taken the environmental 
remediation of their territory into their own hands, painstakingly 
cleaning up the mess that the oil companies have left behind. 
Installation of 53 catchment systems has already begun in Rumipamba, 
starting in May of 2013, which will benefit approximately 350 people. 
ClearWater will also be working with other Kichwa communities in the 
province of Orellana in the near future, ensuring clean water for all 
oil-affected indigenous communities. </p>
    <h4>History</h4>
    <p>The Kichwa of the Amazon, also known as Quichuas or Runas, are the most numerous of Ecuador’s indigenous Amazonian peoples[.1].
 The Kichwa were originally an assemblage of distinct indigenous 
Amazonian groups, forced together by the Spanish for purposes of 
religious conversion and control. The Kichwa language of the Andes was 
imposed upon them and unified these distinct peoples. Hundreds of years 
of forced cohabitation created a unique Amazonian culture, a distinct 
linguistic dialect reflecting their natural surroundings, and a profound
 knowledge of the rainforest environment. The Kichwa community of Rumipamba, located in the Auca Sur oil field, has been one of the hardest hit by Chevron-Texaco’s operations. Decades of reckless dumping into the rivers and streams, and a devastating oil spill from a ruptured pipeline in 1976, have resulted in a community with myriad health and social problems.</p>

<p>Maria Aguinda, a Kichwa woman from Rumipamba who lost her husband and several children to pollution-related health problems, is the lead plaintiff of the lawsuit against Chevron. The Kichwa of Rumipamba have taken cleaning up after the oil companies into their own hands, but they still don’t have access to clean water.</p>
    <small class='scroll'><a href="#">More about the Kichwa</a></small>
  </section>



  <section id="cofan">
    <h2>The Cofan</h2>
    <img src="images/cofan.jpg">
    <ul>
      <li>Community:  Cofan Dureno</li>
      <li>52 Rainwater Catchment Systems</li>
      <li>350 people benefitted</li>
      <li>4 community technicians trained</li>
    </ul>
    <p>The ClearWater project broke ground in the community of Cofán Dureno
 from November, 2011 through February of 2012 when 52 rain catchment 
systems were built, providing 350 people with much-needed clean water. 
The Cofán have perhaps been the hardest hit by oil operations out of all
 indigenous nationalities in the Ecuadorian Amazon. The location of the 
majority of Cofán communities directly downriver from one of Ecuador’s 
largest oil fields— in operation for over 40 years— has resulted in 
serious illness and cultural loss. The Cofán, who have been involved in 
the case against Chevron-Texaco since the beginning, are now active 
participants in the ClearWater project and intend to keep working with 
the project in the future, until all Cofán families have access to clean
 water. You can read about working in Cofán Dureno here.</p>
    <h4>History</h4>
    <p>Centuries ago, the Cofán people moved down from the foothills of the Andes Mountains to inhabit a large territory between the Aguarico River in the northern Ecuadorian Amazon and the Guamués River in southern Colombia. It is estimated that the Cofán (also written as Kofán, or A’I as they prefer to be referred to), numbered between 15,000 and 20,000 people before Spanish conquest and colonization. A brutal history of conquest, abuse, and disease followed.</p>

<p>Extractive industry, colonization, and forced religious conversion took its toll on the Cofán, and they now number around 2,100 people living in a significantly reduced territory. Oil extraction has contaminated much of the Cofán’s lands and rivers and health problems are frequent in Cofán communities, particularly in Dureno, Duvuno, and Sinangüé y Chandía Na'en. The Cofán have been inspiring protagonists in the 19-year legal battle against Chevron, yet they continue to suffer from the devastating contamination in their communities, most significantly the lack of clean water.</p>
    <small class='scroll'><a href="#">More about the Kichwa</a></small>
  </section>


<!--
  <section id="norOriente">
    <h2>Nor-Oriente</h2>
    <img src="images/nor-oriente.jpg">
    <p>Couple of paragraphs about the region and oil drilling here. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco.</p>
    <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
    <small class='scroll'><a href="#">More about the history of oil in the region</a></small>
  </section>
-->





</article>

<article class="cofan-dureno">
  <section class="cover active">
    <h1>Cofan Dureno</h1>
    <p>This pane can include details about number of installations...</p>
    <small class='scroll'>Scroll ▼</small>
  </section>
  <section id="a-2012-08-10-permalink">
    <img src="images/story-1.jpg">
    <h2>Featured Story 1</h2>
    <p>Ut labore et dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam, nisi ut aliquid ex ea commodi consequatur? Quis autem vel eum iure reprehenderit qui in ea voluptate velit esse quam nihil molestiae consequatur, vel illum qui dolorem eum fugiat quo voluptas nulla pariatur?</p>
    <small class='scroll'><a href="#">Read More&hellip;</a></small>
  </section>
  <section id="a-2013-01-02-permalink">
    <img src="images/story-2.jpg">
    <h2>Featured Story 2</h2>
    <p>Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit, sed quia non numquam eius modi tempora incidunt ut labore et dolore magnam aliquam quaerat voluptatem. Ut enim ad minima veniam, quis nostrum exercitationem ullam corporis suscipit laboriosam.</p>
    <small class='scroll'><a href="#">Read More&hellip;</a></small>
  </section>
  <section id="a-2013-02-03-permalink">
    <img src="images/story-3.jpg">
    <h2>Featured Story 3</h2>
    <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo. Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.</p>
    <small class='scroll'><a href="#">Read More&hellip;</a></small>
  </section>
</article>

<script type='text/javascript'>
// Based on the Leaflet example from http://leafletjs.com/examples/choropleth.html

var ECUADOR_BOUNDS = new L.latLngBounds([ [-5.2, -81.2], [1.8, -74.9]]);
var PROJECT_BOUNDS = new L.latLngBounds([ [-1.1, -77.7], [0.5, -75.2]]);
var BING_API_KEY = "AnadQ9NziZo9MYVo8394fMtJjPrkZMasNfSqpt5wz4vUMSaATniZnKxvDgxrsrGB";

var areaDefaultStyle = {
        weight: 2,
        opacity: 0.1,
        color: 'black',
        fillOpacity: 0.7,
        fillColor: '#cc4c02'
      },
    areaHighlightStyle = {
        weight: 2,
        opacity: 0.1,
        color: 'black',
        fillColor: '#ffdf17'
      },
    areaHoverStyle = {
        weight: 1,
        opacity: 0.9,
        color: '#ffdf17'
      },
    areaZoomStyle = {
        weight: 1,
        opacity: 0.9,
        color: '#ffdf17',
        fillOpacity: 0.3,
        fillColor: '#ffdf17'
      },
    bounds = {
      ecuador: ECUADOR_BOUNDS,
      norOriente: PROJECT_BOUNDS
    },
    // Array of story article elements (overview, and one for each community).
    articles = document.getElementsByTagName('article'),
    // Array of story section elements (nation / featured story).
    sections = articles[0].getElementsByTagName('section'),
    installationGeoJson,
    activeSection = 0,
    activeArticle = "overview";

// extend the bounds by a percentage horizontally
L.LatLngBounds.prototype.padXY = function (bufferRatioX, bufferRatioY) { // (Number) -> LatLngBounds
var sw = this._southWest,
    ne = this._northEast,
    heightBuffer = Math.abs(sw.lat - ne.lat) * bufferRatioY,
    widthBuffer = Math.abs(sw.lng - ne.lng) * bufferRatioX;

return new L.LatLngBounds(
        new L.LatLng(sw.lat - heightBuffer, sw.lng - widthBuffer),
  	    new L.LatLng(ne.lat + heightBuffer, ne.lng + widthBuffer));
}

var map = L.mapbox.map('map', 'gmaclennan.map-y7pgvo15', {
  dragging: false,
  touchZoom: false,
  scrollWheelZoom: false,
  doubleClickZoom: false,
  boxZoom: false,
  keyboard: false,
  zoomControl: false
}).fitBounds(ECUADOR_BOUNDS.padXY(0.33, 0));

var bingLayer = new L.BingLayer(BING_API_KEY).addTo(map).bringToBack();

var communityLayer = new L.geoJson(null,  {
      style: getStyle,
      onEachFeature: onEachFeature
  }).addTo(map);

var oms = new OverlappingMarkerSpiderfier(map);

var defaultIcon = new L.Icon({
          iconUrl: "http://a.tiles.mapbox.com/v3/marker/pin-s+17aae4.png",
          iconSize: [20, 50],
          iconAnchor: [10, 25],
          popupAnchor: [0, -25]
        })

var activeIcon = new L.Icon({
          iconUrl: "http://a.tiles.mapbox.com/v3/marker/pin-m+3887be.png",
          iconSize: [30, 70],
          iconAnchor: [15, 35],
          popupAnchor: [0, -35]
        })

var installationLayer = new L.GeoJSON(null, {
    pointToLayer: function (feature, latlng) {
      return L.marker(latlng, {icon: defaultIcon});
    },
    onEachFeature: function (feature, layer) {
      oms.addMarker(layer);
    },
    filter: function (feature, layer) {
      var community = sanitize(feature.properties.location);
      return (community == activeArticle);
    }
  }).addTo(map);

var popup = new L.Popup({ autoPan: false });

// onOverlayLoad is the callback from the JSONP call to CartoDB,
// in the <script> tag at the bottom of the page.
var onOverlayLoad = function(geojson) {
  communityLayer.addData(geojson);
  communityLayer.eachLayer( function(layer) {
    var nacion = sanitize(layer.feature.properties.nacion);
    bounds[nacion] = !bounds[nacion] ? layer.getBounds() : bounds[nacion].extend(layer.getBounds());
  })
  // Set map to first section.
  setActiveSection(0, false);
}

// onDataLoad is the callback from the JSONP call to Google Spreadsheets
// in the <script> tag at the bottom of the page.
var onDataLoad = function(googlejson) {
  installationGeoJson = googledocs2geojson(googlejson);
  installationLayer.addData(installationGeoJson);
}

function getStyle(feature) {
  var nation = sanitize(feature.properties.nacion),
      community = sanitize(feature.properties.nombre),
      section = sections[activeSection].id,
      areaIsHighlighted = (nation == section && community != activeArticle),
      areaIsZoomed = (community == activeArticle);
  if (areaIsHighlighted) return areaHighlightStyle;
  else if (areaIsZoomed) return areaZoomStyle;
  else return areaDefaultStyle;
}

function onEachFeature(feature, layer) {
    layer.on({
        mousemove: mousemoveArea,
        mouseout: mouseout,
        click: zoomToFeature
    });
}

var closeTooltip;

function mousemoveArea(e) {
  var layer = e.target,
      community = sanitize(layer.feature.properties.nombre),
      areaIsZoomed = (community == activeArticle);

  popup.setLatLng(e.latlng);
  popup.setContent('<h2>' + layer.feature.properties.nombre + '</h2><p>' +
      layer.feature.properties.nacion + ' nationality<br>' +
      'XXX Clearwater systems installed<br>' +
      'Click to explore this community</p>');

  if (!popup._map && !areaIsZoomed) popup.openOn(map);
  window.clearTimeout(closeTooltip);

  // highlight feature
  layer.setStyle(areaHoverStyle);

  if (!L.Browser.ie && !L.Browser.opera) {
      layer.bringToFront();
  }
}

function mouseoverMarker(e) {
  var layer = e.target,
      community = sanitize(layer.feature.properties.nombre),
      areaIsZoomed = (community == activeArticle);

  popup.setLatLng(e.latlng);
  popup.setContent('<h2>' + layer.feature.properties.name + '</h2>' +
      '<img src="' + layer.feature.properties.photo + '"><br>' +
      'Location: ' + layer.feature.properties.location + '</p>');

  if (!popup._map) popup.openOn(map);
  window.clearTimeout(closeTooltip);

  if (!L.Browser.ie && !L.Browser.opera) {
      layer.bringToFront();
  }
}

function mouseout(e) {
  communityLayer.resetStyle(e.target);
  closeTooltip = window.setTimeout(function() {
      map.closePopup();
  }, 100);
}

// Load the data for each featured story.
// @TODO need to load asynchronously.
var onFeaturedStoriesLoad = function(json) {
  //console.log(json);
  
  for(var i; i< json.length; i++) {
    if(!json) return;
    if(!json[i]) return;
    if(!json[i].unique_id) return;
/*
    var id = json[i].unique_id;

    switch(id){
      case 'cofan':
        console.log('cofan');
        break;
      default:
        break;
    }
*/
  }

}

function zoomToFeature(e) {
  var community = sanitize(e.target.feature.properties.nombre);
  // If we are already looking at this community, do nothing.
  if (community == activeArticle) return true;
  e.target.off('mousemove', mousemoveArea);
  mouseout(e);
  activeArticle = community;
  
  _(articles).each(function(s) { s.className = s.className.replace(' active', '') });
  articles[1].className += ' active';
  sections = articles[1].getElementsByTagName('section');
  setActiveSection(0);
  window.scrollTo(0,0);
  communityLayer.resetStyle(e.target);
  oms.clearMarkers();
  installationLayer.clearLayers().addData(installationGeoJson); //@TODO is this working?
  map.fitBounds(e.target.getBounds());
  
}

function triggerStoryMarker(target_id) {
  // show markers
  // zoom/highlight the marker
  // set the color
}

// Helper to sanitize a string, replacing spaces with "-" and lowercasing
function sanitize(string) {
  if (typeof(string) != "undefined")
  return string.toLowerCase()
        .replace('http://www.giveclearwater.org/','a-')
        .split(" ").join("-").split("/").join("-");
}

// Helper to set the active section.
var setActiveSection = function(index, ease) {
  if (index == activeSection) return true;
  var sectionId = sections[index].id;
  activeSection = index;
  
  _(sections).each(function(s) { s.className = s.className.replace(' active', '') });
  sections[index].className += ' active';

  // Set a body class for the active section.
  document.body.className = activeArticle + '-section-' + index;
  if (activeArticle == "overview") {
    communityLayer.eachLayer( function (layer) {
      communityLayer.resetStyle(layer);
    })
  
    // Ease map to active marker.
    var sectionBounds = bounds[sectionId].padXY(0.33, 0);
    map.options.maxZoom = 11;
    map.fitBounds(sectionBounds);
    map.options.maxZoom = undefined;
  } else {
    installationLayer.eachLayer( function (layer) {
      var storyId = sanitize(layer.feature.properties.storylink);
      if (storyId == sectionId && sectionId != "") {
        map.setView(layer.getLatLng(), 15);
        layer.setZIndexOffset(250);
        layer.setIcon(activeIcon);
      } else {
        layer.setZIndexOffset(0);
        layer.setIcon(defaultIcon);
      };
    });
  }
  return true;
};

// Bind to scroll events to find the active section.
window.onscroll = _(function() {
  // IE 8
  if (window.pageYOffset === undefined) {
    var y = document.documentElement.scrollTop;
    var h = document.documentElement.clientHeight;
  } else {
    var y = window.pageYOffset;
    var h = window.innerHeight;
  }

  // If scrolled to the very top of the page set the first section active.
  if (y === 0) return setActiveSection(0, true);

  // Otherwise, conditionally determine the extent to which page must be
  // scrolled for each section. The first section that matches the current
  // scroll position wins and exits the loop early.
  var memo = 0;
  var buffer = (h * 0.3333);
  var active = _(sections).any(function(el, index) {
    memo += el.offsetHeight;
    return y < (memo-buffer) ? setActiveSection(index, true) : false;
  });

  // If no section was set active the user has scrolled past the last section.
  // Set the last section active.
  if (!active) setActiveSection(sections.length - 1, true);
}).debounce(10);

</script>

<!--
  This will load geoJSON data from http://clearwater.cartodb.com/ with SQL query
  SELECT ST_Simplify(the_geom, 0.001) AS the_geom, nombre, nacion FROM nationalities
  ST_Simplify simplifies the geometry of the community areas to reduce bandwidth
  It is JSONP so function "onOverlayLoad" will run when the data is loaded.
-->
<script src='http://clearwater.cartodb.com/api/v2/sql?q=SELECT%20ST_Simplify(the_geom,%200.001)%20AS%20the_geom,%20nombre,%20nacion%20FROM%20nationalities&format=geoJSON&callback=onOverlayLoad'></script>

<!-- 
  This will load the JSON from the blog site.
-->
<script src='http://localhost/digidem/clearwater-map/test/featured_stories.json?&callback=onFeaturedStoriesLoad'></script>


<!--
  This will load spreadsheet data from sheet 0AtH_pDdto56YdGwzVU5Mb0F0QjY1WklqYzhtRjJ2d3c
  It needs to be published (via File ... Publish to Web...) in order to work
  See https://developers.google.com/gdata/docs/json and 
  https://developers.google.com/gdata/samples/spreadsheet_sample
  It is JSONP so funtion "onDataLoad" will run when the data is loaded.
-->
<script src='https://spreadsheets.google.com/feeds/list/0AtH_pDdto56YdGwzVU5Mb0F0QjY1WklqYzhtRjJ2d3c/od6/public/values?alt=json-in-script&callback=onDataLoad'></script>

</body>
</html>